<?xml version="1.0" encoding="UTF-8"?>
<project name="mig33_register" default="build" basedir="./../">
	<taskdef uri="antlib:org.sonar.ant" resource="org/sonar/ant/antlib.xml">
		<classpath path="/usr/local/sonar/lib/sonar-ant-task-1.4.jar" />
	</taskdef>
	<property name="sonar.jdbc.url"
		value="jdbc:mysql://localhost:3306/sonar?useUnicode=true&amp;characterEncoding=utf8" />
	<property name="sonar.jdbc.driverClassName" value="com.mysql.jdbc.Driver" />
	<property name="sonar.jdbc.username" value="root" />
	<property name="sonar.jdbc.password" value="ten20304050" />

	<target name="build"
		depends="prepare,lint,phploc,pdepend,phpmd-ci,phpcs-ci,phpcpd,phpunit,sonar"/>
	<target name="build-parallel"
		depends="prepare,lint,tools-parallel,phpunit,sonar"/>
	<target name="build-docs"
		depends="prepare-docs,phpdox,phpcb"/>
	<target name="commit-build">
		<mkdir dir="${basedir}/build/coverage"/>
		<mkdir dir="${basedir}/build/logs"/>
		<antcall target="lint"/>
		<antcall target="phpunit"/>
		<antcall target="sonar-commit-build"/>
	</target>

	<target name="tools-parallel" description="Run tools in parallel">
		<parallel threadCount="3">
			<sequential>
				<antcall target="pdepend"/>
				<antcall target="phpmd-ci"/>
			</sequential>
			<antcall target="phpcpd"/>
			<antcall target="phpcs-ci"/>
			<antcall target="phploc"/>
		</parallel>
	</target>

	<target name="clean" description="Cleanup build artifacts">
		<delete dir="${basedir}/build/coverage"/>
		<delete dir="${basedir}/build/logs"/>
		<delete dir="${basedir}/build/pdepend"/>
	</target>

	<target name="prepare" depends="clean" description="Prepare for build">
		<mkdir dir="${basedir}/build/coverage"/>
		<mkdir dir="${basedir}/build/logs"/>
		<mkdir dir="${basedir}/build/pdepend"/>
	</target>

	<target name="clean-docs" description="Cleanup build docs artifacts">
		<delete dir="${basedir}/build/api"/>
		<delete dir="${basedir}/build/code-browser"/>
	</target>

	<target name="prepare-docs" depends="clean-docs" description="Prepare for build docs">
		<mkdir dir="${basedir}/build/api"/>
		<mkdir dir="${basedir}/build/code-browser"/>
		<mkdir dir="${basedir}/build/phpdox"/>
	</target>

	<target name="lint" description="Perform syntax check of sourcecode files">
		<apply executable="php" failonerror="true">
			<arg value="-l" />

			<fileset dir="${basedir}/src">
				<include name="**/*.php" />
				<modified />
			</fileset>

			<fileset dir="${basedir}/tests">
				<include name="**/*.php" />
				<modified />
			</fileset>
		</apply>
	</target>

	<target name="phploc" description="Measure project size using PHPLOC">
		<exec executable="phploc">
			<arg value="--log-csv" />
			<arg value="${basedir}/build/logs/phploc.csv" />
			<arg path="${basedir}/src" />
		</exec>
	</target>

	<target name="pdepend" description="Calculate software metrics using PHP_Depend">
		<exec executable="pdepend">
			<arg value="--phpunit-xml=${basedir}/build/logs/pdepend.xml" /> <!-- Required for Sonar compatibility -->
			<arg value="--jdepend-xml=${basedir}/build/logs/jdepend.xml" />
			<arg value="--jdepend-chart=${basedir}/build/pdepend/dependencies.svg" />
			<arg value="--overview-pyramid=${basedir}/build/pdepend/overview-pyramid.svg" />
			<arg value="--ignore=${basedir}/tests" />
			<arg path="${basedir}/src" />
		</exec>
	</target>

	<target name="phpmd"
			description="Perform project mess detection using PHPMD and print human readable output. Intended for usage on the command line before committing.">
		<exec executable="phpmd">
			<arg path="${basedir}/src" />
			<arg value="text" />
			<arg value="${basedir}/build/phpmd.xml" />
			<arg value="--exclude" />
			<arg value="${basedir}/src/view" />
			<arg value="--suffixes" />
			<arg value="php,inc" />
		</exec>
	</target>

	<target name="phpmd-ci" description="Perform project mess detection using PHPMD creating a log file for the continuous integration server">
		<exec executable="phpmd">
			<arg path="${basedir}/src" />
			<arg value="xml" />
			<arg value="${basedir}/build/phpmd.xml" />
			<arg value="--reportfile" />
			<arg value="${basedir}/build/logs/pmd.xml" />
			<arg value="--exclude" />
			<arg value="${basedir}/src/view" />
			<arg value="--suffixes" />
			<arg value="php,inc" />
		</exec>
	</target>

	<target name="phpcs"
			description="Find coding standard violations using PHP_CodeSniffer and print human readable output. Intended for usage on the command line before committing.">
		<exec executable="phpcs">
			<arg value="--standard=${basedir}/build/phpcs.xml" />
			<arg value="--extensions=php,inc" />
			<arg path="${basedir}/src" />
		</exec>
	</target>

	<target name="phpcs-ci" description="Find coding standard violations using PHP_CodeSniffer creating a log file for the continuous integration server">
		<exec executable="phpcs" output="/dev/null">
			<arg value="--report=checkstyle" />
			<arg value="--report-file=${basedir}/build/logs/checkstyle.xml" />
			<arg value="--standard=${basedir}/build/phpcs.xml" />
			<arg value="--extensions=php,inc" />
			<arg path="${basedir}/src" />
		</exec>
	</target>

	<target name="phpcpd" description="Find duplicate code using PHPCPD">
		<exec executable="phpcpd">
			<arg value="--log-pmd" />
			<arg value="${basedir}/build/logs/pmd-cpd.xml" />
			<arg value="--exclude" />
			<arg value="${basedir}/sites/view" />
			<arg path="${basedir}/src" />
		</exec>
	</target>

	<target name="phpdox" description="Generate API documentation using phpDox">
		<exec executable="phpdox">
			<arg value="-f" />
			<arg path="${basedir}/build/phpdox.xml" />
		</exec>
	</target>

	<target name="phpunit" description="Run unit tests with PHPUnit">
		<exec executable="phpunit" failonerror="true">
			<arg value="-c" />
			<arg value="${basedir}/build/phpunit.xml" />
		</exec>
	</target>

	<target name="phpcb" description="Aggregate tool output with PHP_CodeBrowser">
		<exec executable="phpcb">
			<arg value="--log" />
			<arg path="${basedir}/build/logs" />
			<arg value="--source" />
			<arg path="${basedir}/sites" />
			<arg value="--output" />
			<arg path="${basedir}/build/code-browser" />
			<arg value="--ignore" />
			<arg path="${basedir}/src/view" />
			<arg value="--ignore" />
			<arg path="${basedir}/tests" />
			<arg value="--exclude" />
			<arg path="${basedir}/src/view" />
			<arg value="--exclude" />
			<arg path="${basedir}/tests" />
		</exec>
	</target>

	<target name="prepare-sonar" description="Prepare for Sonar build">
		<mkdir dir="${basedir}/.sonar"/>
		<mkdir dir="${basedir}/.sonar/target"/>
	</target>

	<target name="sonar" depends="prepare-sonar">
		<property name="sonar.projectName" value="mig33-register-web" />
		<property name="sonar.sources" value="${basedir}/sites" />
		<property name="sonar.tests" value="${basedir}/tests" />
		<property name="sonar.language" value="php" />
		<property name="sonar.sourceEncoding" value="UTF-8" />
<!--		<property name="sonar.exclusions" value="${basedir}/sites/lib/rss/simplepie.inc" />-->

		<property name="sonar.phpDepend.analyzeOnly" value="true" />
		<property name="sonar.phpDepend.reportFileRelativePath" value="../../build/logs" />
		<property name="sonar.phpDepend.reportFileName" value="pdepend.xml" />

		<property name="sonar.phpPmd.analyzeOnly" value="true" />
		<property name="sonar.phpPmd.reportFileRelativePath" value="../../build/logs" />
		<property name="sonar.phpPmd.reportFileName" value="pmd.xml" />

		<property name="sonar.phpCodesniffer.analyzeOnly" value="true" />
		<property name="sonar.phpCodesniffer.reportFileRelativePath" value="../../build/logs" />
		<property name="sonar.phpCodesniffer.reportFileName" value="checkstyle.xml" />
		<property name="sonar.phpCodesniffer.argumentLine" value="--ignore=${basedir}/sites/lib/rss/simplepie.inc" />

		<property name="sonar.phpUnit.analyzeOnly" value="true" />
		<property name="sonar.phpUnit.configuration" value="${basedir}/build/phpunit.xml" />
		<property name="sonar.phpUnit.reportFileRelativePath" value="../../build/logs" />
		<property name="sonar.phpUnit.reportFileName" value="junit.xml" />
		<property name="sonar.phpUnit.coverageReportFile" value="clover.xml" />
		<sonar:sonar key="php-queue" version="${branch}" xmlns:sonar="antlib:org.sonar.ant"/>
	</target>
	
	<target name="sonar-commit-build" depends="prepare-sonar">
		<property name="sonar.projectName" value="mig33-register-web-commit-build" />
		<property name="sonar.sources" value="${basedir}/sites" />
		<property name="sonar.tests" value="${basedir}/tests" />
		<property name="sonar.language" value="php" />
		<property name="sonar.sourceEncoding" value="UTF-8" />
<!--		<property name="sonar.exclusions" value="${basedir}/sites/lib/rss/simplepie.inc" />-->

		<property name="sonar.phpDepend.skip" value="true" />
		<property name="sonar.phpPmd.skip" value="true" />
		<property name="sonar.phpCodesniffer.skip" value="true" />

		<property name="sonar.phpUnit.analyzeOnly" value="true" />
		<property name="sonar.phpUnit.configuration" value="${basedir}/build/phpunit.xml" />
		<property name="sonar.phpUnit.reportFileRelativePath" value="../../build/logs" />
		<property name="sonar.phpUnit.reportFileName" value="junit.xml" />
		<property name="sonar.phpUnit.coverageReportFile" value="clover.xml" />
		<sonar:sonar key="php-queue.commit.build" version="${branch}" xmlns:sonar="antlib:org.sonar.ant"/>
	</target>
</project>
